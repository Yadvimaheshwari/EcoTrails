import React, { useEffect, useState } from 'react';
import { View } from 'react-native';
import { NavigationContainer } from '@react-navigation/native';
import { createNativeStackNavigator } from '@react-navigation/native-stack';
import { StatusBar } from 'expo-status-bar';
import { useAuthStore } from './src/store/useAuthStore';
import { initializeDB } from './src/services/offlineQueue';
import { TabNavigator } from './src/navigation/TabNavigator';
import { ExploreScreen } from './src/screens/ExploreScreen';
import { TrailDetailScreen } from './src/screens/TrailDetailScreen';
import { PlaceDetailScreen } from './src/screens/PlaceDetailScreen';
import { TrackingSetupScreen } from './src/screens/TrackingSetupScreen';
import { DuringHikeScreen } from './src/screens/DuringHikeScreen';
import { EndHikeScreen } from './src/screens/EndHikeScreen';
import { PostHikeReportScreen } from './src/screens/PostHikeReportScreen';
import { CaptureMomentScreen } from './src/screens/CaptureMomentScreen';
import { MediaPickerScreen } from './src/screens/MediaPickerScreen';
import { DeviceManagerScreen } from './src/screens/DeviceManagerScreen';
import { AppleWatchConnectScreen } from './src/screens/AppleWatchConnectScreen';
import { GarminConnectScreen } from './src/screens/GarminConnectScreen';
import { FitbitConnectScreen } from './src/screens/FitbitConnectScreen';
import { LoginScreen } from './src/screens/LoginScreen';
import { Text } from './src/components/ui/Text';
import { colors } from './src/config/colors';

const Stack = createNativeStackNavigator();

export default function App() {
  const { loadAuth, isLoading, user } = useAuthStore();
  const [appReady, setAppReady] = useState(false);

  useEffect(() => {
    const init = async () => {
      await initializeDB();
      await loadAuth();
      setAppReady(true);
    };
    init();
  }, []);

  if (!appReady || isLoading) {
    return null;
  }

  return (
    <NavigationContainer>
      <StatusBar style="dark" />
      <Stack.Navigator
        screenOptions={{
          headerShown: false,
          contentStyle: { backgroundColor: colors.background },
        }}
      >
        {!user ? (
          <Stack.Screen name="Login" component={LoginScreen} />
        ) : (
          <>
            <Stack.Screen name="MainTabs" component={TabNavigator} />
            <Stack.Screen name="TrailDetail" component={TrailDetailScreen} />
            <Stack.Screen name="PlaceDetail" component={PlaceDetailScreen} />
            <Stack.Screen name="TrackingSetup" component={TrackingSetupScreen} />
            <Stack.Screen name="DuringHike" component={DuringHikeScreen} />
            <Stack.Screen name="EndHike" component={EndHikeScreen} />
            <Stack.Screen name="PostHikeReport" component={PostHikeReportScreen} />
            <Stack.Screen name="DeviceManager" component={DeviceManagerScreen} />
            <Stack.Screen name="AppleWatchConnect" component={AppleWatchConnectScreen} />
            <Stack.Screen name="GarminConnect" component={GarminConnectScreen} />
            <Stack.Screen name="FitbitConnect" component={FitbitConnectScreen} />
            <Stack.Screen name="EcoDroidConnect" component={EcoDroidConnectScreen} />
            <Stack.Screen name="CaptureMoment" component={CaptureMomentScreen} />
            <Stack.Screen name="MediaPicker" component={MediaPickerScreen} />
          </>
        )}
      </Stack.Navigator>
    </NavigationContainer>
  );
}

// Placeholder screen for EcoDroid
const EcoDroidConnectScreen = () => (
  <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center', padding: 20 }}>
    <Text variant="h2">Connect EcoDroid</Text>
    <Text variant="body" color="secondary" style={{ marginTop: 16, textAlign: 'center' }}>
      EcoDroid device connection flow will be implemented here
    </Text>
  </View>
);
